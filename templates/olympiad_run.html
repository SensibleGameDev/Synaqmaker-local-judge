{% extends "base.html" %}
{% block title %}–ò–¥—ë—Ç –æ–ª–∏–º–ø–∏–∞–¥–∞!{% endblock %}

{% block content %}
{% set letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' %}

<div class="card shadow-sm mb-4" style="z-index: 1020;">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-3 border-end">
                <h4 class="mb-0">–¢–∞–π–º–µ—Ä: <span id="timer" class="badge bg-secondary">00:00:00</span></h4>
            </div>
            
            <div class="col-md-7 ps-4">
                <div class="d-flex align-items-center mb-2">
                    <h5 class="mb-0 me-3">–£—á–∞—Å—Ç–Ω–∏–∫: <strong>{{ session.get('nickname') }}</strong></h5>
                    {% if oly_session.config.scoring == 'icpc' %}
                        <span id="icpc-total-score" class="badge bg-light text-dark border">–†–µ—à–µ–Ω–æ: 0 | –®—Ç—Ä–∞—Ñ: 0</span>
                    {% endif %}
                </div>
                
                <div id="scoreboard" class="d-flex flex-wrap gap-3">
                    {% for task in oly_session.tasks_details %}
                    <div class="text-center p-1 rounded border bg-light" style="min-width: 60px;">
                        <div class="small text-muted">–ó–∞–¥–∞—á–∞ {{ letters[loop.index0] }}</div>
                        <div id="score-block-{{ task[0] }}" class="fw-bold">
                            {% if oly_session.config.scoring == 'icpc' %}
                                <span class="text-secondary">-</span>
                            {% else %}
                                0
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="col-md-2 text-end">
                <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#scoreboardModal" onclick="loadScoreboard()">
                    <i class="bi bi-trophy-fill"></i> –¢–∞–±–ª–∏—Ü–∞
                </button>
                <form action="{{ url_for('olympiad_finish_early', olympiad_id=olympiad_id) }}" method="POST">
                    <button type="submit" class="btn btn-outline-danger btn-sm w-100" onclick="return confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–ª–∏–º–ø–∏–∞–¥—É?');">
                        –ó–∞–≤–µ—Ä—à–∏—Ç—å
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-tabs" id="taskTabs" role="tablist">
    {% for task in oly_session.tasks_details %}
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if loop.first %}active{% endif %}" id="tab-btn-{{ task[0] }}" data-bs-toggle="tab" data-bs-target="#task-pane-{{ task[0] }}" type="button" role="tab">–ó–∞–¥–∞—á–∞ {{ letters[loop.index0] }}</button>
    </li>
    {% endfor %}
</ul>

<div class="tab-content" id="taskTabsContent">
    {% for task in oly_session.tasks_details %}
    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="task-pane-{{ task[0] }}" role="tabpanel">
        <div class="row mt-3">
            <div class="col-lg-7 col-md-6" style="max-height: 85vh; overflow-y: auto;">
                
                <div class="d-flex justify-content-between align-items-start mb-3 border-bottom pb-2">
                    <h3 class="text-break" style="line-height: 1.2;">{{ letters[loop.index0] }}. {{ task[1] }}</h3>
                    
                    {% if task[5] %}
                    <div class="flex-shrink-0 ms-3">
                        <a href="{{ url_for('display_attachment', task_id=task[0]) }}" target="_blank" class="btn btn-sm btn-outline-primary text-nowrap">
                            <i class="bi bi-file-pdf"></i> PDF
                        </a>
                    </div>
                    {% endif %}
                </div>

                <div class="markdown-content pe-2">{{ task[4] }}</div>
            </div>

            <div class="col-lg-5 col-md-6 d-flex flex-column" style="min-height: 80vh;">
                <div class="flex-grow-1 d-flex flex-column">
                    <form class="submission-form h-100 d-flex flex-column" data-task-id="{{ task[0] }}" data-task-letter="{{ letters[loop.index0] }}">
                        <div class="d-flex justify-content-between align-items-center mb-2 bg-light p-2 rounded">
                            <label class="form-label mb-0 fw-bold small text-uppercase text-muted">–†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞</label>
                            <select id="language-{{ task[0] }}" name="language" class="form-select form-select-sm w-auto border-0 bg-transparent fw-bold text-primary" style="cursor: pointer;">
                                {% set allowed_langs = oly_session.config.allowed_languages or ['Python', 'C++', 'C#'] %}
                                {% set ns = namespace(first_selected=false) %}
                                {% if 'Python' in allowed_langs %}
                                <option value="Python" {% if not ns.first_selected %}selected{% set ns.first_selected = true %}{% endif %}>Python 3.11</option>
                                {% endif %}
                                {% if 'C++' in allowed_langs %}
                                <option value="C++" {% if not ns.first_selected %}selected{% set ns.first_selected = true %}{% endif %}>C++ 17 (G++)</option>
                                {% endif %}
                                {% if 'C#' in allowed_langs %}
                                <option value="C#" {% if not ns.first_selected %}selected{% set ns.first_selected = true %}{% endif %}>C# Mono</option>
                                {% endif %}
                            </select>
                        </div>
                        
                        <div class="flex-grow-1 border rounded overflow-hidden mb-2 shadow-sm">
                            <textarea id="code-{{ task[0] }}" name="code" class="form-control h-100"></textarea>
                        </div>

                        <div class="status-alert-box mb-2" id="alert-box-{{ task[0] }}" style="display: none;"></div>

                        <button type="submit" id="submit-btn-{{ task[0] }}" class="btn btn-success w-100 py-2 fw-bold shadow-sm">
                            <i class="bi bi-play-fill"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ
                        </button>
                    </form>
                </div>

                <div class="mt-3 border rounded p-2 bg-white shadow-sm" style="height: 220px; min-height: 220px; overflow-y: auto;">
                    <h6 class="text-muted border-bottom pb-1 mb-2 small text-uppercase fw-bold">
                        <i class="bi bi-clock-history"></i> –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å—ã–ª–æ–∫
                    </h6>
                    <table class="table table-sm table-hover text-center align-middle" style="font-size: 0.8rem;">
                        <thead class="table-light sticky-top" style="top: -8px;">
                            <tr>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–ó–∞–¥–∞—á–∞</th>
                                <th>–Ø–∑—ã–∫</th>
                                <th>–í–µ—Ä–¥–∏–∫—Ç</th>
                                <th>–¢–µ—Å—Ç—ã</th>
                            </tr>
                        </thead>
                        <tbody class="history-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="modal fade" id="scoreboardModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-trophy"></i> –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="frozen-badge-container"></div>
        <div id="scoreboard-loader" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-striped text-center table-sm" id="full-scoreboard-table">
            </table>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
    const olympiadId = "{{ olympiad_id }}";
    const myNickname = "{{ session.get('nickname') }}";
    const scoringMode = "{{ oly_session.config.scoring }}";
    const participantId = "{{ participant_id }}";
    
    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Socket.IO (–æ–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –≤—Å—é —Å—Ç—Ä–∞–Ω–∏—Ü—É)
    const socket = io();

    // --- –§–£–ù–ö–¶–ò–Ø 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ (Async) ---
    function handleSubmissionResult(data) {
        // data = { task_id, passed, new_score, verdict, details ... }
        
        const taskId = data.task_id;
        const alertBox = document.getElementById(`alert-box-${taskId}`);
        const btn = document.getElementById(`submit-btn-${taskId}`);
        
        // 1. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play-fill"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ';
        }

        // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –∞–ª–µ—Ä—Ç
        let alertClass = 'alert-danger';
        let alertText = '–û—à–∏–±–∫–∞';

        if (data.passed) {
            alertClass = 'alert-success';
            alertText = `<strong>Accepted!</strong> –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ.`;
        } else if (data.verdict === "CE") {
            alertClass = 'alert-dark text-white';
            alertText = `<strong>Compilation Error</strong>`;
        } else {
            // –ò—â–µ–º –ø–µ—Ä–≤—ã–π —É–ø–∞–≤—à–∏–π —Ç–µ—Å—Ç –≤ details
            let failText = data.verdict; // WA/RE/TL
            if (data.details) {
                const fail = data.details.find(d => d.verdict !== 'Accepted');
                if (fail) failText = `${fail.verdict} –Ω–∞ —Ç–µ—Å—Ç–µ ${fail.test_num}`;
            }
            alertText = `<strong>${failText}</strong>`;
        }

        if (alertBox) {
            alertBox.innerHTML = alertText;
            // Bootstrap —Ü–≤–µ—Ç–∞: bg-success + bg-opacity-25 –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∏—è—Ç–Ω–µ–µ —á–µ–º —è—Ä–∫–∏–π alert-success
            let bgClass = alertClass.replace('alert-', 'bg-');
            if (bgClass !== 'bg-dark') bgClass += ' bg-opacity-25';
            
            alertBox.className = `status-alert-box mb-2 p-3 rounded border border-${alertClass.replace('alert-', '')} ${bgClass}`;
            if (data.verdict === "CE") alertBox.classList.add('text-white');
            alertBox.style.display = 'block';
        }

        // 3. [–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –£–¥–∞–ª—è–µ–º —Ñ–µ–π–∫–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ "–í –æ—á–µ—Ä–µ–¥–∏" –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
        const pendingRows = document.querySelectorAll('.pending-row');
        pendingRows.forEach(row => row.remove());

        // 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç–æ—è—â—É—é –∏—Å—Ç–æ—Ä–∏—é –∏–∑ –±–∞–∑—ã
        loadHistory();
    }

    // –°–ª—É—à–∞–µ–º –õ–ò–ß–ù–´–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ –æ—á–µ—Ä–µ–¥–∏
    socket.on('personal_result', function(msg) {
        if (msg.participant_id === participantId) {
            handleSubmissionResult(msg.data);
        }
    });

    // --- –§–£–ù–ö–¶–ò–Ø 2: –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ ---
    async function loadHistory() {
        try {
            const res = await fetch(`/olympiad/api/history/${olympiadId}`);
            if (!res.ok) {
                console.error("History fetch failed:", res.status);
                return;
            }
            const data = await res.json();
            
            const tables = document.querySelectorAll('.history-body');
            tables.forEach(tbody => {
                // [FIX] –ù–µ —Ç—Ä–æ–≥–∞–µ–º pending-row, –ø—Ä–æ—Å—Ç–æ –¥–æ–ø–æ–ª–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
                const currentRows = tbody.querySelectorAll('tr:not(.pending-row)');
                
                // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–Ω–æ –Ω–µ pending)
                currentRows.forEach(r => r.remove());
                
                data.forEach(row => {
                    let badgeClass = 'bg-secondary';
                    let verdictText = row.verdict;

                    if (row.verdict === 'Accepted' || row.verdict === 'OK') badgeClass = 'bg-success';
                    else if (row.verdict === 'Time Limit Exceeded') { badgeClass = 'bg-warning text-dark'; verdictText = 'TLE'; }
                    else if (row.verdict && row.verdict.includes('Compilation')) { badgeClass = 'bg-dark'; verdictText = 'CE'; }
                    else if (row.verdict === 'Runtime Error') { badgeClass = 'bg-danger'; verdictText = 'RE'; }
                    else badgeClass = 'bg-danger'; // WA
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-muted">${row.time}</td>
                        <td class="fw-bold">${row.letter}</td>
                        <td>${row.language}</td>
                        <td><span class="badge ${badgeClass}">${verdictText}</span></td>
                        <td>${row.tests}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });

        } catch (e) {
            console.error("History load error:", e);
        }
    }

    // --- –§–£–ù–ö–¶–ò–Ø 3: –¢–∞–±–ª–∏—Ü–∞ (Scoreboard) ---
    async function loadScoreboard() {
        const modalTable = document.getElementById('full-scoreboard-table');
        const loader = document.getElementById('scoreboard-loader');
        if (!modalTable || !loader) return;

        modalTable.innerHTML = '';
        modalTable.classList.add('d-none');
        loader.classList.remove('d-none');
        
        try {
            const res = await fetch(`/olympiad/api/scoreboard/${olympiadId}`);
            const data = await res.json();
            const isICPC = data.config.scoring === 'icpc';
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            
            // Show frozen badge if applicable (in separate container)
            const frozenBadgeContainer = document.getElementById('frozen-badge-container');
            if (data.is_frozen) {
                frozenBadgeContainer.innerHTML = '<div class="alert alert-warning mb-2"><i class="bi bi-snow"></i> <strong>–¢–∞–±–ª–∏—Ü–∞ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞!</strong> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –∑–∞–º–æ—Ä–æ–∑–∫–∏ —Å–∫—Ä—ã—Ç—ã (–æ—Ç–º–µ—á–µ–Ω—ã –∑–Ω–∞–∫–æ–º "?").</div>';
            } else {
                frozenBadgeContainer.innerHTML = '';
            }
            
            let headerHtml = '<thead class="table-dark"><tr><th>#</th><th>–£—á–∞—Å—Ç–Ω–∏–∫</th>';
            let taskCount = 0;
            if (data.config.task_ids) taskCount = data.config.task_ids.length;
            else if (data.scoreboard.length) taskCount = Object.keys(data.scoreboard[0].scores).length;

            for(let i=0; i<taskCount; i++) headerHtml += `<th>${letters[i] || (i+1)}</th>`;
            headerHtml += `<th>–ò—Ç–æ–≥–æ</th></tr></thead><tbody>`;
            
            data.scoreboard.forEach((p, index) => {
                let rankDisplay = index + 1;
                let rowClass = '';
                if (index === 0) { rankDisplay = 'ü•á 1'; rowClass = 'table-warning'; }
                else if (index === 1) { rankDisplay = 'ü•à 2'; rowClass = 'table-secondary'; }
                else if (index === 2) { rankDisplay = 'ü•â 3'; }

                let rowHtml = `<tr class="${rowClass}">
                    <td class="fw-bold">${rankDisplay}</td>
                    <td class="text-start fw-bold">${p.nickname} ${p.organization ? `<br><small class="text-muted">${p.organization}</small>` : ''}</td>`;
                
                const taskIds = data.config.task_ids || Object.keys(p.scores);
                taskIds.forEach(tid => {
                    let s = p.scores[tid] || {score:0, passed:false, attempts:0, penalty:0};
                    let frozenS = p.frozen_scores ? (p.frozen_scores[tid] || s) : s;
                    let cellContent = '.';
                    let cellClass = '';
                    
                    // Check if there's frozen activity (changes during freeze)
                    const hasFrozenActivity = data.is_frozen && p.frozen_scores &&
                        (s.attempts !== frozenS.attempts || s.passed !== frozenS.passed);
                    
                    if (isICPC) {
                        if (hasFrozenActivity) {
                            // Show frozen state with orange color and "?" indicator
                            cellClass = 'table-warning';
                            const displayAttempts = frozenS.attempts || 0;
                            cellContent = `<span class="text-dark fw-bold">?${displayAttempts}</span>`;
                        } else if (s.passed) {
                            cellContent = `<span class="text-success fw-bold">+${s.attempts > 0 ? s.attempts : ''}</span><br><small class="text-muted">${s.penalty}</small>`;
                            cellClass = 'table-success';
                        } else if (s.attempts > 0) {
                            cellContent = `<span class="text-danger">-${s.attempts}</span>`;
                        }
                    } else {
                        cellContent = s.score;
                        if (s.passed) cellClass = 'table-success fw-bold';
                        else if (s.score > 0) cellClass = 'table-warning';
                    }
                    rowHtml += `<td class="${cellClass}">${cellContent}</td>`;
                });
                
                // Use frozen totals during freeze for participants
                const displayTotalScore = data.is_frozen && p.frozen_total_score !== undefined ? p.frozen_total_score : p.total_score;
                const displayTotalPenalty = data.is_frozen && p.frozen_total_penalty !== undefined ? p.frozen_total_penalty : p.total_penalty;
                rowHtml += `<td class="fw-bold">${displayTotalScore} ${isICPC ? `<span class="text-muted small">(${displayTotalPenalty})</span>` : ''}</td></tr>`;
                headerHtml += rowHtml;
            });
            headerHtml += '</tbody>';
            modalTable.innerHTML = headerHtml;
        } catch (e) {
            modalTable.innerHTML = `<tr><td class="text-danger">–û—à–∏–±–∫–∞: ${e.message}</td></tr>`;
        } finally {
            loader.classList.add('d-none');
            modalTable.classList.remove('d-none');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const timerEl = document.getElementById('timer');
        loadHistory();

        // –¢–∞–π–º–µ—Ä
        let countdownInterval = null;
        function startServerTimer(secondsLeft) {
            if (countdownInterval) clearInterval(countdownInterval);
            let timeLeft = Math.floor(secondsLeft);
            const draw = () => {
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    timerEl.textContent = "00:00:00";
                    timerEl.className = 'badge bg-danger';
                    return;
                }
                const h = Math.floor(timeLeft / 3600).toString().padStart(2, '0');
                const m = Math.floor((timeLeft % 3600) / 60).toString().padStart(2, '0');
                const s = Math.floor(timeLeft % 60).toString().padStart(2, '0');
                timerEl.textContent = `${h}:${m}:${s}`;
                timeLeft < 300 ? timerEl.className = 'badge bg-warning text-dark' : timerEl.className = 'badge bg-secondary';
                timeLeft--;
            };
            draw();
            countdownInterval = setInterval(draw, 1000);
        }

        // Socket: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (–¢–∞–π–º–µ—Ä + Scoreboard)
        socket.on('connect', () => socket.emit('join_room', { room: olympiadId }));
        socket.on('full_status_update', (data) => {
            if (data.status === 'running') startServerTimer(data.remaining_seconds);
            else timerEl.textContent = "–ó–∞–≤–µ—Ä—à–µ–Ω–æ";

            const me = data.scoreboard.find(p => p.participant_id === participantId);
            if (!me) return;

            // –û–±–Ω–æ–≤–ª—è–µ–º Header (–†–µ—à–µ–Ω–æ/–®—Ç—Ä–∞—Ñ)
            if (scoringMode === 'icpc') {
                const totalScoreEl = document.getElementById('icpc-total-score');
                const displayScore = data.is_frozen && me.frozen_total_score !== undefined ? me.frozen_total_score : me.total_score;
                const displayPenalty = data.is_frozen && me.frozen_total_penalty !== undefined ? me.frozen_total_penalty : me.total_penalty;
                if (totalScoreEl) totalScoreEl.innerHTML = `–†–µ—à–µ–Ω–æ: <strong>${displayScore}</strong> | –®—Ç—Ä–∞—Ñ: <strong>${displayPenalty}</strong>`;
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏-–±–ª–æ–∫–∏ –∑–∞–¥–∞—á
            for (const taskId in me.scores) {
                const s = me.scores[taskId];
                const frozenS = me.frozen_scores ? (me.frozen_scores[taskId] || s) : s;
                const hasFrozenActivity = data.is_frozen && me.frozen_scores &&
                    (s.attempts !== frozenS.attempts || s.passed !== frozenS.passed);
                const el = document.getElementById(`score-block-${taskId}`);
                if (el) {
                    if (scoringMode === 'icpc') {
                        if (hasFrozenActivity) {
                            el.innerHTML = `<span class="text-warning">?${frozenS.attempts || 0}</span>`;
                        } else if (s.passed) {
                            el.innerHTML = `<span class="text-success">+${s.attempts > 0 ? s.attempts : ''}</span>`;
                        } else if (s.attempts > 0) {
                            el.innerHTML = `<span class="text-danger">-${s.attempts}</span>`;
                        }
                        else el.innerHTML = `<span class="text-secondary">-</span>`;
                    } else {
                        el.innerHTML = s.score;
                        if (s.passed) el.className = 'fw-bold text-success';
                    }
                }
            }
        });
        socket.on('olympiad_finished', () => window.location.href = `{{ url_for('olympiad_end', olympiad_id=olympiad_id) }}`);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
        const editors = {};
        document.querySelectorAll('.submission-form').forEach(form => {
            const taskId = form.dataset.taskId;
            const taskLetter = form.dataset.taskLetter;
            const textArea = document.getElementById(`code-${taskId}`);
            const alertBox = document.getElementById(`alert-box-${taskId}`);
            const submitBtn = document.getElementById(`submit-btn-${taskId}`);
            const langSelect = document.getElementById(`language-${taskId}`);
            
            // Determine initial mode based on selected language
            const selectedLang = langSelect.value;
            let initialMode = 'python';
            if (selectedLang === 'C++') initialMode = 'text/x-c++src';
            else if (selectedLang === 'C#') initialMode = 'text/x-csharp';
            
            const editor = CodeMirror.fromTextArea(textArea, {
                lineNumbers: true, mode: initialMode, theme: 'material-darker', matchBrackets: true, indentUnit: 4
            });
            editor.setSize("100%", "100%");
            setTimeout(() => editor.refresh(), 100);
            editors[taskId] = editor;

            langSelect.addEventListener('change', (e) => {
                const lang = e.target.value;
                if (lang === 'C++') {
                    editor.setOption('mode', 'text/x-c++src');
                } else if (lang === 'C#') {
                    editor.setOption('mode', 'text/x-csharp'); // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç clike.min.js
                } else {
                    editor.setOption('mode', 'python');
                }
            });

            // –û–¢–ü–†–ê–í–ö–ê (ASYNC)
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const code = editors[taskId].getValue();
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Pending...';
                
                // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∞–ª–µ—Ä—Ç
                alertBox.style.display = 'none';

                // –î–æ–±–∞–≤–ª—è–µ–º "—Ñ–µ–π–∫–æ–≤—É—é" —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∏–¥–µ—Ç
                const historyTables = document.querySelectorAll('.history-body');
                const now = new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                const loadingRow = document.createElement('tr');
                loadingRow.className = 'table-warning pending-row'; // –ö–ª–∞—Å—Å pending-row –≤–∞–∂–µ–Ω –¥–ª—è loadHistory
                loadingRow.innerHTML = `
                    <td class="text-muted">${now}</td>
                    <td class="fw-bold">${taskLetter}</td>
                    <td>${form.language.value}</td>
                    <td class="fw-bold text-primary"><span class="spinner-grow spinner-grow-sm"></span> Pending...</td>
                    <td>...</td>
                `;
                historyTables.forEach(t => t.prepend(loadingRow.cloneNode(true)));

                try {
                    const res = await fetch("{{ url_for('olympiad_submit', olympiad_id=olympiad_id) }}", {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ task_id: taskId, language: form.language.value, code: code })
                    });
                    const data = await res.json();
                    
                    if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞');

                    // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ (status: queued)
                    if (data.status === 'queued') {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ
                        submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> –ü–æ–∑–∏—Ü–∏—è: ${data.queue_size}`;
                        // –î–∞–ª—å—à–µ –∂–¥–µ–º —Å–æ–±—ã—Ç–∏—è –∏–∑ —Å–æ–∫–µ—Ç–∞ (handleSubmissionResult)
                    } 

                } catch (error) {
                    alertBox.innerHTML = `–û—à–∏–±–∫–∞: ${error.message}`;
                    alertBox.className = 'alert alert-danger';
                    alertBox.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-play-fill"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ';
                    
                    // [FIX Issue 2] Explicitly remove pending-row on submission error
                    document.querySelectorAll('.pending-row').forEach(row => row.remove());
                    loadHistory(); // Reload actual history
                }
            });
        });

        // Refresh editor layout when tab changes
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tabBtn => {
            tabBtn.addEventListener('shown.bs.tab', () => {
                // 1. –û–±–Ω–æ–≤–ª—è–µ–º CodeMirror (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª —Å–µ—Ä—ã–º)
                for (let tid in editors) editors[tid].refresh();

                // 2. –û–±–Ω–æ–≤–ª—è–µ–º MathJax (—á—Ç–æ–±—ã —Ñ–æ—Ä–º—É–ª—ã –ø–æ—è–≤–∏–ª–∏—Å—å)
                if (window.MathJax) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º typesetPromise, —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –¥–ª—è –¥–∏–Ω–∞–º–∏–∫–∏
                    MathJax.typesetPromise();
                }
            });
        });
    });
</script>
{% endblock %}
