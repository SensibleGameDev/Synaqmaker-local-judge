{% extends "base.html" %}
{% block title %}–ü–∞–Ω–µ–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞{% endblock %}

{% block content %}
<style>
    /* –ê–Ω–∏–º–∞—Ü–∏—è –º–∏–≥–∞–Ω–∏—è –¥–ª—è "Pending" */
    @keyframes flash-yellow {
        0%, 100% { background-color: #ffffff; }
        50% { background-color: #fff3cd; } 
    }
    .pending-flash {
        animation: flash-yellow 1.5s infinite;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –≤—Å–ø—ã—à–∫–∏ –¥–ª—è "Success" */
    @keyframes flash-green {
        0% { background-color: #d1e7dd; }
        100% { background-color: #cce7d8; } 
    }
    .flash-success {
        animation: flash-green 1.5s ease-out;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –≤—Å–ø—ã—à–∫–∏ –¥–ª—è "Fail" */
    @keyframes flash-red {
        0% { background-color: #f8d7da; }
        100% { background-color: #f8d7da; } 
    }
    .flash-fail {
        animation: flash-red 1.5s ease-out;
    }
    
    /* * –°–¢–ò–õ–¨ –î–õ–Ø –ü–õ–ê–í–ù–û–ì–û –ü–ï–†–ï–ú–ï–©–ï–ù–ò–Ø (FLIP)
    */
    #scoreboard-body tr {
        /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é transition –≤—ã–∫–ª—é—á–µ–Ω. 
          –ú—ã –±—É–¥–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å –µ–≥–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏.
        */
        transition: none;
    }
    /* FTS —Å—Ç–∏–ª–∏ –¥–ª—è —Ö–æ—Å—Ç–∞ */
    .first-to-solve {
        background-color: #73d78a !important; /* –¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π */
        border-color: #86f19f !important;
        position: relative;
    }
    .first-to-solve::after {
        content: '‚òÖ';
        position:  absolute;
        top: -8px; /* –ß—É—Ç—å –≤—ã—à–µ, —á–µ–º —É –∑—Ä–∏—Ç–µ–ª—è, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–∞–¥–¥–∏–Ω–≥–æ–≤ */
        right: -4px;
        font-size: 1.2em;
        color: #ffc107;
        text-shadow: 1px 1px 2px black;
    }
</style>


<div class="jumbotron bg-light p-5 rounded">
    <h1 class="display-4">–í—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä!</h1>
    <p class="lead">ID –≤–∞—à–µ–π –æ–ª–∏–º–ø–∏–∞–¥—ã: <kbd class="fs-4">{{ olympiad_id }}</kbd></p>
    <p class="lead">–†–µ–∂–∏–º: 
        {% if oly_mode == 'closed' %}
        <span class="badge bg-danger">–ó–∞–∫—Ä—ã—Ç—ã–π</span>
        {% else %}
        <span class="badge bg-success">–°–≤–æ–±–æ–¥–Ω—ã–π</span>
        {% endif %}
    </p>
    <p class="lead">–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —è–∑—ã–∫–∏: 
        {% set allowed_langs = olympiad_data.config.allowed_languages or ['Python', 'C++', 'C#'] %}
        {% for lang in allowed_langs %}
        <span class="badge bg-primary">{{ lang }}</span>
        {% endfor %}
    </p>
    {% set freeze_mins = olympiad_data.config.freeze_minutes or 0 %}
    {% if freeze_mins > 0 %}
    <p class="lead">
        <i class="bi bi-snow"></i> –ó–∞–º–æ—Ä–æ–∑–∫–∞: 
        <span class="badge bg-info">–ó–∞ {{ freeze_mins }} –º–∏–Ω –¥–æ –∫–æ–Ω—Ü–∞</span>
        <span id="freeze-status" class="badge bg-secondary d-none">–ó–ê–ú–û–†–û–ñ–ï–ù–û</span>
    </p>
    {% endif %}
    <h4 id="timer-block" class="d-none mt-3">–û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è: <span id="timer" class="badge bg-secondary">00:00:00</span></h4>
    <hr class="my-4">

    <div id="start-section">
        <p>–°–æ–æ–±—â–∏—Ç–µ —ç—Ç–æ—Ç ID —Å—Ç—É–¥–µ–Ω—Ç–∞–º. –ö–æ–≥–¥–∞ –≤—Å–µ –ø–æ–¥–∫–ª—é—á–∞—Ç—Å—è, –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –æ–ª–∏–º–ø–∏–∞–¥—É".</p>
        <button id="start-btn" class="btn btn-success btn-lg">–ù–∞—á–∞—Ç—å –æ–ª–∏–º–ø–∏–∞–¥—É –¥–ª—è –≤—Å–µ—Ö!</button>
    </div>

    <div id="running-section" class="d-none">
        <h3 class="text-success">–û–ª–∏–º–ø–∏–∞–¥–∞ –∑–∞–ø—É—â–µ–Ω–∞!</h3>
        <p>–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö.</p>
        <button id="finish-btn" class="btn btn-danger">–ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–ª–∏–º–ø–∏–∞–¥—É –¥–ª—è –≤—Å–µ—Ö</button>
        <a href="{{ url_for('olympiad_end', olympiad_id=olympiad_id) }}" class="btn btn-info">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</a>
        <a href="{{ url_for('spectate_olympiad', olympiad_id=olympiad_id) }}" class="btn btn-outline-dark" target="_blank">
            <i class="bi bi-tv"></i> –ó—Ä–∏—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º
        </a>
        
        {% set freeze_mins = olympiad_data.config.freeze_minutes or 0 %}
        {% if freeze_mins > 0 %}
        <div id="presentation-mode-section" class="mt-3 d-none">
            <div class="alert alert-warning">
                <h5><i class="bi bi-snow"></i> –†–µ–∂–∏–º –∑–∞–º–æ—Ä–æ–∑–∫–∏ –∞–∫—Ç–∏–≤–µ–Ω!</h5>
                <p class="mb-2">–¢–∞–±–ª–∏—Ü–∞ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –∑—Ä–∏—Ç–µ–ª–µ–π. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ª–∏–º–ø–∏–∞–¥—ã –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ü–µ—Ä–µ–º–æ–Ω–∏—é —Ä–∞—Å–∫—Ä—ã—Ç–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.</p>
                <a href="{{ url_for('olympiad_presentation', olympiad_id=olympiad_id) }}" class="btn btn-dark" target="_blank">
                    <i class="bi bi-projector-fill"></i> –û—Ç–∫—Ä—ã—Ç—å —Ä–µ–∂–∏–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if oly_mode == 'closed' %}
<div class="card mt-4">
    <div class="card-header">
        <h4><i class="bi bi-person-lines-fill"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ (–ó–∞–∫—Ä—ã—Ç—ã–π —Ä–µ–∂–∏–º)</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-5">
                <h5>–î–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é</h5>
                <form action="{{ url_for('olympiad_add_participant', olympiad_id=olympiad_id) }}" method="POST">
                    <div class="mb-2">
                        <label class="form-label">–ù–∏–∫–Ω–µ–π–º</label>
                        <input type="text" name="nickname" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="text" name="organization" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                        <input type="text" name="password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </form>
                <hr class="my-4">
                <h5>–ò–º–ø–æ—Ä—Ç –∏–∑ Excel (.xlsx)</h5>
                <p class="small text-muted">–®–∞–±–ª–æ–Ω: 1-—è –∫–æ–ª–æ–Ω–∫–∞ - –ù–∏–∫–Ω–µ–π–º, 2-—è - –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, 3-—è - –ü–∞—Ä–æ–ª—å. (–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤)</p>
                <form action="{{ url_for('olympiad_upload_participants', olympiad_id=olympiad_id) }}" method="POST" enctype="multipart/form-data">
                     <div class="mb-2">
                         <input type="file" name="participant_file" class="form-control" accept=".xlsx,.xls" required>
                     </div>
                     <button type="submit" class="btn btn-success">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                </form>
            </div>
            <div class="col-md-7">
                <h5>"–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫" ({{ whitelist|length }})</h5>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>–ù–∏–∫–Ω–µ–π–º</th>
                                <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in whitelist %}
                            <tr>
                                <td>{{ p.nickname }}</td>
                                <td>{{ p.organization }}</td>
                                <td>
                                    {% if p.id|string in olympiad_data.participants %}
                                        <span class="badge bg-success">–í–æ—à–µ–ª</span>
                                    {% else %}
                                        <span class="badge bg-secondary">–û–∂–∏–¥–∞–µ—Ç</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form action="{{ url_for('olympiad_remove_participant', olympiad_id=olympiad_id, participant_db_id=p.id) }}" method="POST" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞?');">
                                        <button type="submit" class="btn btn-danger btn-sm" title="–£–¥–∞–ª–∏—Ç—å">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <a href="{{ url_for('olympiad_print_cards', olympiad_id=olympiad_id) }}" target="_blank" class="btn btn-warning">
    <i class="bi bi-printer"></i> –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ (–õ–æ–≥–∏–Ω—ã/–ü–∞—Ä–æ–ª–∏)
</a>
</div>
{% endif %}
<div class="row mt-4">
    <div class="col-md-4">
        <h4>–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏:</h4>
        <ul id="participants-list" class="list-group">
            <li class="list-group-item">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...</li>
        </ul>
    </div>
    
    <div class="col-md-8">
        <h4>–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (Live):</h4>
        <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>–ù–∏–∫–Ω–µ–π–º</th>
                            <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                            {% set letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' %}
                                {% for task in tasks %}
                                    <th class="text-center">–ó–∞–¥–∞—á–∞ {{ letters[loop.index0] }}</th>
                                {% endfor %}
                            
                            {% if olympiad_data.config.scoring == 'icpc' %}
                                <th class="text-center">–†–µ—à–µ–Ω–æ</th>
                                <th class="text-center">–®—Ç—Ä–∞—Ñ</th>
                            {% else %}
                                <th class="text-center">–ò—Ç–æ–≥</th>
                            {% endif %}
                            
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th> </tr>
                    </thead>
                    <tbody id="scoreboard-body">
            </tbody>
        </table>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    const olympiadId = "{{ olympiad_id }}";
    const startSection = document.getElementById('start-section');
    const runningSection = document.getElementById('running-section');
    const timerBlock = document.getElementById('timer-block');
    const timerEl = document.getElementById('timer');
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è ID —è—á–µ–µ–∫, –∫–æ—Ç–æ—Ä—ã–µ –∞–Ω–∏–º–∏—Ä—É—é—Ç—Å—è
    let animatedCells = new Set();
    let timerInterval = null;

    // --- –¢–ê–ô–ú–ï–† ---
    function startHostTimer(secondsLeft) {
        if (timerInterval) clearInterval(timerInterval);
        let timeLeft = Math.floor(secondsLeft);

        function draw() {
            if (timeLeft <= 0) {
                timerEl.textContent = '–í—Ä–µ–º—è –≤—ã—à–ª–æ!';
                timerEl.classList.remove('bg-secondary');
                timerEl.classList.add('bg-danger');
                clearInterval(timerInterval);
                return;
            }
            const h = String(Math.floor(timeLeft / 3600)).padStart(2, '0');
            const m = String(Math.floor((timeLeft % 3600) / 60)).padStart(2, '0');
            const s = String(timeLeft % 60).padStart(2, '0');
            timerEl.textContent = `${h}:${m}:${s}`;
            timeLeft--;
        }
        draw();
        timerInterval = setInterval(draw, 1000);
    }

    // --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø ---
    function updateHostView(data) {
        try {
            // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ —Ç–∞–π–º–µ—Ä
            if (data.status === 'running' || data.status === 'finished') {
                startSection.classList.add('d-none');
                runningSection.classList.remove('d-none');
                timerBlock.classList.remove('d-none');
                
                if (data.status === 'finished') {
                    timerEl.textContent = "–ó–∞–≤–µ—Ä—à–µ–Ω–æ";
                    timerEl.classList.add('bg-danger');
                    if(timerInterval) clearInterval(timerInterval);
                } else {
                    startHostTimer(data.remaining_seconds);
                }
            }
            
            // Update freeze status indicator
            const freezeStatus = document.getElementById('freeze-status');
            const presentationSection = document.getElementById('presentation-mode-section');
            if (freezeStatus) {
                if (data.is_frozen) {
                    freezeStatus.classList.remove('d-none', 'bg-secondary');
                    freezeStatus.classList.add('bg-info');
                    freezeStatus.textContent = '–ó–ê–ú–û–†–û–ñ–ï–ù–û';
                    // Show presentation mode section during freeze
                    if (presentationSection) {
                        presentationSection.classList.remove('d-none');
                    }
                } else {
                    freezeStatus.classList.add('d-none');
                    if (presentationSection) {
                        presentationSection.classList.add('d-none');
                    }
                }
            }
            
            if (data.status === 'finished') {
                const finishBtn = document.getElementById('finish-btn');
                if(finishBtn) {
                    finishBtn.disabled = true;
                    finishBtn.textContent = '–û–ª–∏–º–ø–∏–∞–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
                }
            }

            // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—Å–ª–µ–≤–∞)
            const participantsList = document.getElementById('participants-list');
            participantsList.innerHTML = '';
            if (data.participants.length > 0) {
                data.participants.forEach(name => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = name;
                    participantsList.appendChild(li);
                });
            } else {
                participantsList.innerHTML = '<li class="list-group-item">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è</li>';
            }

            // --- 3. –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ---
            const scoreboardBody = document.getElementById('scoreboard-body');
            const scoringMode = data.config.scoring;
            
            // –ü–æ–ª—É—á–∞–µ–º ID –∑–∞–¥–∞—á –∏–∑ Jinja –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const taskIds = [
                {% for task in tasks %}
                    {{ task[0] }},
                {% endfor %}
            ];
            
            // (FLIP: 1. –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏)
            const oldPositions = new Map();
            for (const row of scoreboardBody.rows) {
                if(row.dataset.participantId) {
                    oldPositions.set(row.dataset.participantId, row.getBoundingClientRect().top);
                }
            }
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            if (scoringMode === 'icpc') {
                data.scoreboard.sort((a, b) => {
                    if (b.total_score !== a.total_score) return b.total_score - a.total_score;
                    return a.total_penalty - b.total_penalty;
                });
            } else {
                data.scoreboard.sort((a, b) => b.total_score - a.total_score);
            }

            // –£–¥–∞–ª—è–µ–º –≤—ã–±—ã–≤—à–∏—Ö (–∏–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã)
            const newPlayerIds = new Set(data.scoreboard.map(p => p.participant_id));
            for (const row of scoreboardBody.rows) {
                if (row.dataset.participantId && !newPlayerIds.has(row.dataset.participantId)) {
                    row.remove();
                }
            }

            // –†–µ–Ω–¥–µ—Ä —Å—Ç—Ä–æ–∫
            data.scoreboard.forEach((player, index) => {
                const playerId = player.participant_id;
                let row = document.getElementById(`row-${playerId}`);
                
                if (!row) {
                    row = scoreboardBody.insertRow();
                    row.id = `row-${playerId}`;
                    row.dataset.participantId = playerId;
                }
                
                row.dataset.rank = index + 1;

                // –ö–Ω–æ–ø–∫–∞ –¥–∏—Å–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏
                const dq_url = `/olympiad/host/${olympiadId}/disqualify/${player.participant_id}`;
                const dq_form = `
                    <form action="${dq_url}" method="POST" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?');" style="display:inline;">
                        <button type="submit" class="btn btn-danger btn-sm" title="–î–∏—Å–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å">
                            <i class="bi bi-x-octagon-fill"></i>
                        </button>
                    </form>
                `;
                
                let rowHTML = `<th scope="row">${index + 1}</th>
                               <td><strong>${player.nickname}</strong></td>
                               <td>${player.organization || ''}</td>`;
                
                // –Ø–ß–ï–ô–ö–ò –ó–ê–î–ê–ß
                taskIds.forEach(tid => {
                    const scoreInfo = player.scores[String(tid)] || player.scores[tid];
                    const frozenScoreInfo = player.frozen_scores ? (player.frozen_scores[String(tid)] || player.frozen_scores[tid]) : null;
                    const cellId = `cell-${playerId}-${tid}`;
                    let cellClass = '';
                    let cellContent = '0';
                    
                    // === [FTS LOGIC] ===
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —ç—Ç–æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫ –≤ —Å–ø–∏—Å–∫–µ –ø–µ—Ä–≤—ã—Ö —Ä–µ—à–∏–≤—à–∏—Ö
                    // data.first_solves –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ —Å –∫–ª—é—á–∞–º–∏-—Å—Ç—Ä–æ–∫–∞–º–∏, –ø–æ—ç—Ç–æ–º—É String(tid)
                    const isFirstSolver = (data.first_solves && data.first_solves[String(tid)] === playerId);
                    // ===================
                    
                    // Check if there's frozen activity (changes during freeze)
                    const hasFrozenActivity = data.is_frozen && frozenScoreInfo &&
                        (scoreInfo.attempts !== frozenScoreInfo.attempts || 
                         scoreInfo.passed !== frozenScoreInfo.passed);

                    if (scoreInfo) {
                         if (scoringMode === 'icpc') {
                            if (scoreInfo.passed) {
                                cellClass = 'table-success';
                                cellContent = `+${scoreInfo.attempts > 0 ? scoreInfo.attempts : ''} <small class="text-muted">(${scoreInfo.penalty})</small>`;
                                
                                // –ï—Å–ª–∏ FTS -> –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü –∫–ª–∞—Å—Å
                                if (isFirstSolver) cellClass += ' first-to-solve';
                                
                                // Show indication of frozen activity for host
                                if (hasFrozenActivity) cellContent += ' <span class="badge bg-info">üîí</span>';

                            } else if (scoreInfo.attempts > 0) {
                                cellClass = 'table-danger';
                                cellContent = `-${scoreInfo.attempts}`;
                                
                                // Show indication of frozen activity for host
                                if (hasFrozenActivity) cellContent += ' <span class="badge bg-info">üîí</span>';
                            } else {
                                cellContent = `0`;
                            }
                        } else { 
                            // –ë–∞–ª–ª—ã
                            if (scoreInfo.passed) {
                                cellClass = 'table-success';
                                if (isFirstSolver && scoreInfo.score === 100) cellClass += ' first-to-solve';
                            }
                            cellContent = `${scoreInfo.score} <small class="text-muted">(${scoreInfo.attempts})</small>`;
                            
                            // Show indication of frozen activity for host
                            if (hasFrozenActivity) cellContent += ' <span class="badge bg-info">üîí</span>';
                        }
                    }
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
                    const oldCell = document.getElementById(cellId);
                    if (!animatedCells.has(cellId)) {
                        if (oldCell) oldCell.classList.remove('pending-flash');
                        
                        if (oldCell && oldCell.innerHTML !== cellContent) {
                            let animClass = '';
                            if (cellClass.includes('table-success')) animClass = 'flash-success';
                            else if (cellClass.includes('table-danger')) animClass = 'flash-fail';
                            if (animClass) cellClass += ` ${animClass}`;
                        }
                    }
                    
                    rowHTML += `<td class="text-center ${cellClass}" id="${cellId}">${cellContent}</td>`;
                });
                
                // –ò–¢–û–ì–ò
                if (scoringMode === 'icpc') {
                    rowHTML += `<td class="text-center"><strong>${player.total_score}</strong></td>`;
                    rowHTML += `<td class="text-center"><strong>${player.total_penalty}</strong></td>`;
                } else {
                    rowHTML += `<td class="text-center"><strong>${player.total_score}</strong></td>`;
                }
                rowHTML += `<td>${dq_form}</td>`;
                
                row.innerHTML = rowHTML;
            });
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ DOM —É–∑–ª–æ–≤
            const sortedRows = Array.from(scoreboardBody.rows)
                .sort((a, b) => parseInt(a.dataset.rank) - parseInt(b.dataset.rank));
            
            sortedRows.forEach(row => scoreboardBody.appendChild(row));

            // (FLIP: 3. –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è)
            requestAnimationFrame(() => {
                for (const row of sortedRows) {
                    const id = row.dataset.participantId;
                    const oldTop = oldPositions.get(id);
                    if (oldTop === undefined) continue;
                    
                    const newTop = row.getBoundingClientRect().top;
                    const deltaY = oldTop - newTop;

                    if (deltaY !== 0) {
                        row.style.transition = 'none';
                        row.style.transform = `translateY(${deltaY}px)`;
                        
                        requestAnimationFrame(() => {
                             row.style.transition = 'transform 0.6s ease-in-out';
                             row.style.transform = '';
                        });
                    }
                }
            });

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Host View:", error);
        }
    }

    // --- SOCKET IO ---
    const socket = io();

    socket.on('connect', () => {
        console.log('Socket.IO: –•–æ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω.');
        socket.emit('join_room', { room: olympiadId });
    });

    socket.on('full_status_update', (data) => {
        updateHostView(data);
    });

    socket.on('submission_pending', (data) => {
        const cellId = `cell-${data.participant_id}-${data.task_id}`;
        const cell = document.getElementById(cellId);
        if (cell) {
            cell.classList.add('pending-flash');
            animatedCells.add(cellId);
            setTimeout(() => animatedCells.delete(cellId), 3000);
        }
    });

    // –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø
    const startBtn = document.getElementById('start-btn');
    if (startBtn) {
        startBtn.addEventListener('click', async () => {
            if (!confirm('–ù–∞—á–∞—Ç—å –æ–ª–∏–º–ø–∏–∞–¥—É?')) return;
            await fetch(`/olympiad/start/${olympiadId}`, { method: 'POST' });
        });
    }

    const finishBtn = document.getElementById('finish-btn');
    if (finishBtn) {
        finishBtn.addEventListener('click', async () => {
            if (!confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö?')) return;
            await fetch(`/olympiad/finish_by_host/${olympiadId}`, { method: 'POST' });
            window.location.href = `{{ url_for('olympiad_end', olympiad_id=olympiad_id) }}`;
        });
    }
</script>
{% endblock %}