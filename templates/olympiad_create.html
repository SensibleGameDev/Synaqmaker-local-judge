{% extends "base.html" %}
{% block title %}Настройка Олимпиады{% endblock %}
{% block content %}
<style>
    .task-scroll-area {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        background-color: #f8f9fa; /* Светлый фон для контраста */
    }
    .selected-task-item {
        cursor: default;
        transition: all 0.2s;
    }
    .selected-task-item:hover {
        background-color: #e9ecef;
    }
    .task-letter-badge {
        width: 30px;
        display: inline-block;
        text-align: center;
        font-weight: bold;
    }
</style>

<h2>Настройка олимпиады</h2>
<p>Сформируйте список задач (A, B, C...). Порядок важен!</p>
<hr>

<form method="POST" id="create-olympiad-form">
    
    <div id="hidden-inputs-container"></div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-search"></i> Доступные задачи
                </div>
                <div class="card-body d-flex flex-column">
                    <input type="text" id="task-search" class="form-control mb-3" placeholder="Поиск задачи...">
                    
                    <div class="task-scroll-area p-2 flex-grow-1">
                        <div class="list-group" id="source-task-list">
                            {% for task in tasks %}
                            <button type="button" 
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center source-task-btn" 
                                    data-id="{{ task[0] }}" 
                                    data-title="{{ task[1] }}" 
                                    data-diff="{{ task[2] }}">
                                <span>
                                    <strong>{{ task[1] }}</strong> 
                                    <span class="badge bg-secondary rounded-pill">{{ task[2] }}</span>
                                </span>
                                <i class="bi bi-plus-circle text-primary"></i>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    <small class="text-muted mt-2">Нажмите, чтобы добавить задачу в олимпиаду.</small>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card h-100 border-success">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-list-ol"></i> Выбранные задачи (<span id="task-counter">0</span>/10)
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="task-scroll-area p-2 flex-grow-1 bg-white" id="selected-tasks-container">
                        <div class="text-center text-muted mt-5" id="empty-msg">
                            Список пуст. Добавьте задачи слева.
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-danger mt-3 btn-sm" id="clear-all-btn">Очистить список</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">Время</div>
                <div class="card-body">
                    <label>Длительность (мин):</label>
                    <input type="number" class="form-control" name="duration" min="1" max="300" value="120" required>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">Система оценки</div>
                <div class="card-body">
                    <select class="form-select" name="scoring">
                        <option value="all_or_nothing" selected>Всё или ничего (100 б.)</option>
                        <option value="per_test">Баллы за тесты</option>
                        <option value="icpc">ICPC (Штрафы)</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">Доступ</div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="mode" id="m1" value="free" checked>
                        <label class="form-check-label" for="m1">Свободный</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="mode" id="m2" value="closed">
                        <label class="form-check-label" for="m2">Закрытый</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">Разрешённые языки программирования</div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="allowed_languages" id="lang-python" value="Python" checked>
                        <label class="form-check-label" for="lang-python">Python 3.11</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="allowed_languages" id="lang-cpp" value="C++" checked>
                        <label class="form-check-label" for="lang-cpp">C++ 17 (G++)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="allowed_languages" id="lang-csharp" value="C#" checked>
                        <label class="form-check-label" for="lang-csharp">C# Mono</label>
                    </div>
                    <div class="form-text mt-2">Выберите языки, которые будут доступны участникам.</div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header"><i class="bi bi-snow"></i> Заморозка таблицы (ICPC)</div>
                <div class="card-body">
                    <label>Заморозить за N минут до конца:</label>
                    <input type="number" class="form-control" name="freeze_minutes" min="0" max="120" value="0" placeholder="0 = без заморозки">
                    <div class="form-text mt-2">
                        Таблица результатов будет скрыта за указанное время до конца соревнования. 
                        После завершения можно будет провести эффектную церемонию раскрытия в стиле ICPC World Finals.
                        Оставьте 0 для отключения заморозки.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-3">
    <label class="form-label">Название олимпиады (необязательно)</label>
    <input type="text" name="name" class="form-control" placeholder="Например: Рубежный контроль №2">
</div>
<div class="mb-3">
    <label class="form-label">Запланировать старт (необязательно)</label>
    <input type="datetime-local" name="start_time_local" class="form-control">
    <div class="form-text">Если оставить пустым, олимпиада будет создана в режиме ожидания.</div>
</div>
    <button type="submit" id="submit-btn" class="btn btn-success btn-lg w-100 mb-5" disabled>Создать олимпиаду</button>
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const sourceList = document.getElementById('source-task-list');
    const selectedContainer = document.getElementById('selected-tasks-container');
    const emptyMsg = document.getElementById('empty-msg');
    const hiddenInputsContainer = document.getElementById('hidden-inputs-container');
    const counterSpan = document.getElementById('task-counter');
    const submitBtn = document.getElementById('submit-btn');
    const searchInput = document.getElementById('task-search');

    // Массив выбранных задач (храним объекты {id, title, diff})
    let selectedTasks = [];

    // Функция обновления отображения выбранных задач
    function renderSelectedTasks() {
        selectedContainer.innerHTML = '';
        hiddenInputsContainer.innerHTML = '';

        if (selectedTasks.length === 0) {
            selectedContainer.appendChild(emptyMsg);
            submitBtn.disabled = true;
            counterSpan.textContent = 0;
            return;
        }

        selectedTasks.forEach((task, index) => {
            // 1. Генерируем букву (A, B, C...)
            const letter = String.fromCharCode(65 + index); // 65 = 'A'

            // 2. Создаем элемент списка
            const div = document.createElement('div');
            div.className = 'd-flex justify-content-between align-items-center p-2 border-bottom selected-task-item';
            div.innerHTML = `
                <div>
                    <span class="badge bg-primary task-letter-badge me-2">${letter}</span>
                    <strong>${task.title}</strong> 
                    <small class="text-muted">(${task.diff})</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger remove-task-btn" data-index="${index}">
                    <i class="bi bi-x-lg"></i>
                </button>
            `;
            selectedContainer.appendChild(div);

            // 3. Создаем скрытый input для отправки формы
            // ВАЖНО: input-ы создаются в том же порядке, что и в массиве. 
            // Flask получит их именно в этом порядке.
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'task_ids';
            input.value = task.id;
            hiddenInputsContainer.appendChild(input);
        });

        // Обновляем счетчик и кнопку
        counterSpan.textContent = selectedTasks.length;
        if (selectedTasks.length >= 1 && selectedTasks.length <= 10) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true; // Лимит задач (можно убрать условие <= 10 если надо)
        }
    }

    // Обработчик клика по задаче в левом списке (Добавление)
    sourceList.addEventListener('click', (e) => {
        const btn = e.target.closest('.source-task-btn');
        if (!btn) return;

        if (selectedTasks.length >= 10) {
            alert("Максимум 10 задач!");
            return;
        }

        const id = btn.dataset.id;
        
        // Проверка на дубликаты
        if (selectedTasks.some(t => t.id === id)) {
            alert("Эта задача уже добавлена!");
            return;
        }

        selectedTasks.push({
            id: id,
            title: btn.dataset.title,
            diff: btn.dataset.diff
        });

        renderSelectedTasks();
    });

    // Обработчик удаления (делегирование событий)
    selectedContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('.remove-task-btn');
        if (!btn) return;

        const index = parseInt(btn.dataset.index);
        selectedTasks.splice(index, 1); // Удаляем из массива
        renderSelectedTasks(); // Перерисовываем
    });

    // Очистить все
    document.getElementById('clear-all-btn').addEventListener('click', () => {
        selectedTasks = [];
        renderSelectedTasks();
    });

    // Поиск
    searchInput.addEventListener('keyup', () => {
        const filter = searchInput.value.toLowerCase();
        const buttons = sourceList.querySelectorAll('.source-task-btn');
        buttons.forEach(btn => {
            const title = btn.dataset.title.toLowerCase();
            if (title.includes(filter)) {
                btn.style.display = ''; // Показать (flex, но bootstrap classes override it properly usually)
                btn.classList.add('d-flex'); // Возвращаем d-flex
            } else {
                btn.style.display = 'none';
                btn.classList.remove('d-flex');
            }
        });
    });
});
</script>
{% endblock %}