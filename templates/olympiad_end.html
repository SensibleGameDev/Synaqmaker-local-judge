{% extends "base.html" %}
{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ª–∏–º–ø–∏–∞–¥—ã{% endblock %}
{% block content %}
<div class="text-center">
    <h1 class="display-4">–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h1>
    {% if results.status != 'finished' %}
        <p class="lead text-warning">–û–ª–∏–º–ø–∏–∞–¥–∞ –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –≠—Ç–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.</p>
    {% else %}
        <p class="lead text-success">–û–ª–∏–º–ø–∏–∞–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</p>
    {% endif %}
</div>
<hr>

<div class="row justify-content-center">
    <div class="col-md-10">
        {% if is_frozen_display %}
        <div class="alert alert-info mb-4">
            <h5><i class="bi bi-snow"></i> –¢–∞–±–ª–∏—Ü–∞ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞</h5>
            <p class="mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—ã–ª–∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω—ã –≤–æ –≤—Ä–µ–º—è –æ–ª–∏–º–ø–∏–∞–¥—ã. –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç —Ä–∞—Å–∫—Ä—ã—Ç—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–º –Ω–∞ —Ü–µ—Ä–µ–º–æ–Ω–∏–∏ –Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è.</p>
        </div>
        {% endif %}
        
        {% if is_organizer and has_frozen_data %}
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-snow"></i> –¶–µ—Ä–µ–º–æ–Ω–∏—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (ICPC Style)</h5>
            </div>
            <div class="card-body">
                <p>–î–ª—è —ç—Ç–æ–π –æ–ª–∏–º–ø–∏–∞–¥—ã –¥–æ—Å—Ç—É–ø–Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç–Ω–∞—è —Ü–µ—Ä–µ–º–æ–Ω–∏—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Å—Ç–∏–ª–µ ICPC World Finals.</p>
                <div class="d-flex gap-3 flex-wrap">
                    <a href="{{ url_for('olympiad_presentation', olympiad_id=olympiad_id) }}" class="btn btn-dark btn-lg">
                        <i class="bi bi-projector-fill"></i> –†–µ–∂–∏–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ (–¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ—Ä–∞)
                    </a>
                    <a href="{{ url_for('olympiad_reveal', olympiad_id=olympiad_id) }}" class="btn btn-warning btn-lg">
                        <i class="bi bi-play-circle-fill"></i> –ù–∞—á–∞—Ç—å —Ü–µ—Ä–µ–º–æ–Ω–∏—é —Ä–∞—Å–∫—Ä—ã—Ç–∏—è
                    </a>
                    <a href="{{ url_for('api_export_frozen', olympiad_id=olympiad_id) }}" class="btn btn-outline-info">
                        <i class="bi bi-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞–º–æ—Ä–æ–∑–∫–∏ (JSON)
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if participants_list and participants_list|length >= 3 %}
        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-trophy-fill"></i> –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    {% set winners = [] %}
                    {% set prev_score = None %}
                    {% set prev_penalty = None %}
                    {% set current_place = 0 %}
                    {% for player in participants_list if not player.disqualified %}
                        {% if loop.index <= 3 or (prev_score == player.total_score and prev_penalty == player.total_penalty) %}
                            {% if prev_score != player.total_score or prev_penalty != player.total_penalty %}
                                {% set current_place = loop.index %}
                            {% endif %}
                            {% if current_place <= 3 %}
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100 {% if current_place == 1 %}border-warning{% elif current_place == 2 %}border-secondary{% else %}border-danger{% endif %}">
                                        <div class="card-body">
                                            <h1 class="display-1">
                                                {% if current_place == 1 %}ü•á{% elif current_place == 2 %}ü•à{% else %}ü•â{% endif %}
                                            </h1>
                                            <h4>{{ player.nickname }}</h4>
                                            <p class="text-muted">{{ player.organization or '-' }}</p>
                                            <p>
                                                <strong>{{ player.total_score }}</strong> —Ä–µ—à–µ–Ω–æ
                                                {% if results.config.scoring == 'icpc' %}
                                                    | {{ player.total_penalty }} —à—Ç—Ä–∞—Ñ
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            {% set prev_score = player.total_score %}
                            {% set prev_penalty = player.total_penalty %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="card">
            <div class="card-header">
                <h4>–ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ (ID: {{ olympiad_id }})</h4>
            </div>
            <div class="card-body">
                
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">–ù–∏–∫–Ω–µ–π–º</th>
                            <th scope="col">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                            {% set letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' %} 
                            {% for task in tasks %}
                                <th scope="col" class="text-center">–ó–∞–¥–∞—á–∞ {{ letters[loop.index0] }}</th>
                            {% endfor %}
                            
                            {% if results.config.scoring == 'icpc' %}
                                <th scope="col" class="text-center">–†–µ—à–µ–Ω–æ</th>
                                <th scope="col" class="text-center">–®—Ç—Ä–∞—Ñ</th>
                            {% else %}
                                <th scope="col" class="text-center">–ò—Ç–æ–≥</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in participants_list %}
                        
                            {% if player.disqualified %}
                            <tr class="table-danger">
                                <th scope="row">{{ loop.index }}</th>
                                <td><del><strong>{{ player.nickname }}</strong></del></td>
                                <td><del>{{ player.organization or '' }}</del></td>
                            {% else %}
                            <tr>
                                <th scope="row">{{ loop.index }}</th>
                                <td><strong>{{ player.nickname }}</strong></td>
                                <td>{{ player.organization or '' }}</td>
                            {% endif %}

                            {% for task in tasks %}
                                {# [FIX] –ò—â–µ–º –±–∞–ª–ª—ã —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ (int –∏–ª–∏ str), –∏–Ω–∞—á–µ –±–µ—Ä–µ–º –Ω—É–ª–∏ #}
                                {% set score_info = player.scores.get(task[0]) or player.scores.get(task[0]|string) or {'score': 0, 'attempts': 0, 'passed': False, 'penalty': 0} %}
                                
                                <td class="text-center 
                                    {% if score_info.passed %}table-success
                                    {% elif results.config.scoring == 'icpc' and score_info.attempts > 0 %}table-danger
                                    {% endif %}">
                                    
                                    {% if results.config.scoring == 'icpc' %}
                                        {% if score_info.passed %}
                                            +{{ score_info.attempts if score_info.attempts > 0 else '' }}
                                            <small class="text-muted">({{ score_info.penalty }})</small>
                                        {% elif score_info.attempts > 0 %}
                                            -{{ score_info.attempts }}
                                        {% else %}
                                            .
                                        {% endif %}
                                    {% else %}
                                        {{ score_info.score }}
                                        <small class="text-muted">({{ score_info.attempts }})</small>
                                    {% endif %}
                                </td>
                            {% endfor %} 
                            
                            {% if player.disqualified %}
                                <td class="text-center" colspan="{% if results.config.scoring == 'icpc' %}2{% else %}1{% endif %}">
                                    <strong><span class="badge bg-danger">–î–∏—Å–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω</span></strong>
                                </td>
                            {% else %}
                                <td class="text-center"><strong>{{ player.total_score }}</strong></td>
                                {% if results.config.scoring == 'icpc' %}
                                    <td class="text-center"><strong>{{ player.total_penalty }}</strong></td>
                                {% endif %}
                            {% endif %}
                            </tr>

                        {% else %}
                            <td colspan="{{ 4 + tasks|length + (1 if results.config.scoring == 'icpc' else 0) }}" class="text-center text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <p class="text-muted mt-2"><small>
                    {% if results.config.scoring == 'icpc' %}
                        –í —Å–∫–æ–±–∫–∞—Ö —É–∫–∞–∑–∞–Ω–æ —à—Ç—Ä–∞—Ñ–Ω–æ–µ –≤—Ä–µ–º—è (–≤ –º–∏–Ω—É—Ç–∞—Ö).
                    {% else %}
                        –í —Å–∫–æ–±–∫–∞—Ö —É–∫–∞–∑–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–≤–µ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –¥–æ –∑–∞—á–µ—Ç–∞.
                    {% endif %}
                </small></p>
            </div>
        </div>
        <div class="text-center mt-4">
            <a href="{{ url_for('olympiad_join') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –æ–ª–∏–º–ø–∏–∞–¥–∞–º
            </a>
            {% if is_organizer %}
            <a href="{{ url_for('api_get_winners', olympiad_id=olympiad_id) }}" class="btn btn-info">
                <i class="bi bi-trophy"></i> API: –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ (JSON)
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}